<!--
 * @Author: chaoxiaoshu-mx leukotrichia@163.com
 * @Date: 2023-02-02 08:39:13
 * @LastEditors: chaoxiaoshu-mx leukotrichia@163.com
 * @LastEditTime: 2023-11-01 10:52:09
 * @FilePath: \ThingsPanel-Backend-Vue\src\view\pages\automation\scene\index.vue
 * @Description: 场景列表
-->
<template>
  <div class="rounded card p-4">
    <el-row typ="flex" :gutter="20" class="pt-3 pb-3 px-3">
      <el-col :span="12">
        <TableTitle>{{ $t('AUTOMATION.SCENE_MANAGEMENT')}}</TableTitle>
      </el-col>
      <el-col :span="12" class="text-right">
        <el-button type="border"  @click="handleShowAdd">{{ $t('AUTOMATION.ADD_SCENE')}}</el-button>
      </el-col>
    </el-row>

    <!-- 表 start -->
    <el-table :data="tableData" v-loading="loading">
      <el-table-column :label="$t('AUTOMATION.NO')" type="index" width="100" align="left">
        <template v-slot="scope">
          <span>{{ (params.current_page - 1) * 10 + scope.$index + 1 }}</span>
        </template>
      </el-table-column>
      <el-table-column :label="$t('AUTOMATION.SCENE_NAME')" prop="scenario_name" ></el-table-column>
      <el-table-column :label="$t('AUTOMATION.SCENE_DESCRIPTION')" prop="scenario_description" ></el-table-column>
      <el-table-column :label="$t('AUTOMATION.CREATE_AT')" prop="created_at">
        <template v-slot="scope">
          {{ scope.row.created_at ? formatDate(scope.row.created_at) : "" }}
        </template>
      </el-table-column>
      <el-table-column align="left" :label="$t('AUTOMATION.OPERATION')"  width="280">
        <template v-slot="scope">
          <div style="text-align: right">
            <el-button type="success" size="mini"  @click="handleActive(scope.row)">激活</el-button>
            <el-button type="border" size="mini"  @click="handleShowEdit(scope.row)">{{ $t('AUTOMATION.EDIT')}}</el-button>
            <el-button type="info" size="mini"  @click="handleShowLog(scope.row)">{{ $t('AUTOMATION.LOG')}}</el-button>
            <!-- <el-button type="danger" size="mini"  @click="handleDelete(scope.row)">删除</el-button> -->

            <!-- 删除 -->
            <el-popconfirm :confirm-button-text="$t('COMMON.CONFIRM')" :cancel-button-text="$t('COMMON.CANCEL')" title="删除" @confirm="handleDelete(scope.row)">
              <el-button style="margin-left:10px;" slot="reference" type="danger" size="mini" >{{ $t('AUTOMATION.DELETE')}}</el-button>
            </el-popconfirm>

          </div>
        </template>
      </el-table-column>
      
      <template #empty>
        <div>{{ $t('COMMON.TABLE_NO_DATA') }}</div>
      </template>
    </el-table>
    <!-- 表 end -->

    <div class="text-right py-3">
      <el-pagination
          background
          layout="prev, pager, next"
          :total="total"
          :current-page.sync="params.current_page"
          :page-size="params.per_page"
          @current-change="getSceneList"></el-pagination>
    </div>

    <EditForm :visible.sync="editDialogVisible" :id="formId" @submit="getSceneList"/>

    <Logger :visible.sync="logDialogVisible" :data="currentItem"/>
  </div>
</template>

<script>
import TableTitle from "@/components/common/TableTitle";
import EditForm from "./EditForm";
import Logger from "./Logger";
import Auto  from "@/api/automation_1.0"
import "@/core/mixins/common"
import { message_success } from '@/utils/helpers';

export default {
  name: "index",
  components: { TableTitle, EditForm, Logger },
  data() {
    return {
      tableData: [],
      loading: false,
      total: 0,
      params: {
        current_page: 1,
        per_page: 10
      },
      editDialogVisible: false,
      logDialogVisible: false,
      formId: "",
      currentItem: {}
    }
  },
  created() {
    this.getSceneList();
  },
  methods: {
    getSceneList() {
      this.loading = true;
      Auto.Scene.list(this.params)
        .then(({data}) => {
          if (data.code === 200) {
            this.tableData = data.data?.data || [];
            this.total = data.data?.total || 0;
          }
        })
        .finally(() => {
          this.loading = false;
        })
    },
    handleShowAdd() {
      this.formId = "";
      this.editDialogVisible = true;
    },
    /**
     * 激活
     */
    handleActive(item) {
      Auto.Scene.active({id: item.id})
        .then(res => {
          if (res.data.code === 200) {
            message_success("激活成功");
          }
        })
    },
    handleShowEdit(item) {
      this.formId = item.id;
      this.editDialogVisible = true;
    },
    handleShowLog(item) {
      this.formId = item.id;
      this.currentItem = JSON.parse(JSON.stringify(item));
      this.logDialogVisible = true;
    },
    handleDelete(item) {
      Auto.Scene.delete({ id: item.id })
        .then(res => {
          if (res.data.code === 200) {
            this.getSceneList();
            message_success(this.$t('AUTOMATION.DELETE_SUCCESS'));
          }
        })
    }
  }
}
</script>

<style scoped>

</style>